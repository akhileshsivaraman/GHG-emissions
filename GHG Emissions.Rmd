---
title: "GHG Emissions"
output: 
  html_document:
    theme:
      bg: "#f2f1f2"
      fg: "#0f1015"
      base_font:
        google: Inter
      heading_font:
        google: Inter
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

## Questions

* How are UK emissions changing?
  * Overall trends
  * Industries and sectors contributing the most to emissions
  * Industries and sectors reducing emissions the quickest and the slowest
* How might emissions change over the next 5 years?
* What are the implications of this for the UK government?

```{r message=FALSE}
# libraries
library(tidyverse)
library(forecast)

# functions
source("pct_change.R")
source("industry_forecast.R")

# load data
ghg_section_totals <- read_csv("annual_emissions_section_totals.csv")
ghg_sector_totals <- read_csv("annual_emissions_breakdown.csv")

# colour palette
bg <- "#f2f1f2"
fg <- "#0f1015"
primary <- "#7b2454"

# scales
options(scipen = 10000)

# plot theming
theme_nao <- theme(
    panel.grid = element_blank(),
    plot.background = element_rect(fill = bg),
    panel.background = element_rect(fill = bg),
    text = element_text(colour = primary),
    axis.text = element_text(colour = primary),
    axis.line = element_line(colour = primary),
    axis.ticks = element_line(colour = primary)
  )
```

___
## How are UK emissions changing?
### Overall trends

* GHG emissions are trending downwards with a 40.4% reduction in the mass of air emission per annum in thousand tonnes of C02 equivalent
* GHG emissions in 2021 are 340'158 thousand tonnes of CO2e lower than in 1990
```{r}
#---- total annual emissions ----
# prepare data
annual_emissions <- ghg_section_totals[22,]
annual_emissions <- annual_emissions |>
  pivot_longer(cols = c("1990":"2021"),
               names_to = "Year",
               values_to = "Emissions") |>
  select(!`Section letter`) |>
  mutate(Year = as.numeric(Year))



# percentage change
total_GHG_1990 <- annual_emissions |>
  filter(Year == "1990") |>
  pull(Emissions)

total_GHG_2021 <- annual_emissions |>
  filter(Year == "2021") |>
  pull(Emissions)

total_GHG_pct_change <- ((total_GHG_2021 - total_GHG_1990) / total_GHG_1990) * 100

# absolute change
total_GHG_2021 - total_GHG_1990

# summary plot
ggplot(annual_emissions) +
  geom_point(aes(Year, Emissions), colour = primary) +
  ylab("Mass of air emission per annum in thousand tonnes of CO2e") +
  theme_nao
```


### Industries
```{r}
# prepare data
annual_section_emissions <- ghg_section_totals[-c(22),] |>
  pivot_longer(cols = c("1990":"2021"),
               names_to = "Year",
               values_to = "Emissions") |>
  mutate(Year = as.numeric(Year))

# summary plot
ggplot(annual_section_emissions) +
  geom_point(aes(Year, Emissions), colour = primary) +
  facet_wrap(~ `Section name`, labeller = labeller(`Section name` = label_wrap_gen(width = 30))) +
  scale_x_continuous(n.breaks = 2) +
  theme_nao +
  theme(strip.text.x = element_text(size = 8, colour = primary),
        strip.background = element_rect(fill = bg))
```

Industries contributing the most to emissions:

* Eight have contributed heavily to total emissions over the 31-year period
* All 8 were amongst the top 8 highest emitters in 2021
* In 1990, Public Administration was in the top 8 and has since been displaced by Wholesale and Retail
```{r}
# total emissions over period
ghg_section_total_period <- ghg_section_totals |>
  rowwise(`Section name`) |>
  summarise(total_emissions = sum(c_across("1990":"2021")),
            `Section letter` = `Section letter`) |>
  arrange(desc(total_emissions)) |>
  rename("Total emissions" = total_emissions) |>
  mutate(`Section letter` = case_when(`Section name` == "Consumer expenditure" ~ "CE",
                                      TRUE ~ `Section letter`))

ggplot(ghg_section_total_period |>
         filter(`Section name` != "Total greenhouse gas emissions")) +
  geom_col(aes(`Section letter`, `Total emissions`), fill = primary) +
  theme_nao


# top emitters in 2021
absolute_top_emitting_section_2021 <- ghg_section_totals |>
  filter(`Section name` != "Total greenhouse gas emissions") |>
  slice_max(order_by = `2021`, n = 8) |>
  select(c("Section letter", "Section name", "2021"))

# top emitters in 1990
absolute_top_emitting_section_1990 <- ghg_section_totals |>
  filter(`Section name` != "Total greenhouse gas emissions") |>
  slice_max(order_by = `1990`, n = 8) |>
  select(c("Section letter", "Section name", "1990"))

setdiff(absolute_top_emitting_section_2021$`Section name`, absolute_top_emitting_section_1990$`Section name`)
setdiff(absolute_top_emitting_section_1990$`Section name`, absolute_top_emitting_section_2021$`Section name`)
```


Industries reducing emissions the quickest and the slowest:

* Although emissions have fallen overall, there has not been a reduction in emissions across the board. Construction, Real Estate, Wholesale & Retail Trade, Administrative Activities and Accommodation & Food Services have seen increases
* Comparatively, amongst the top 8 emitters, Agriculture, Forestry & Fishing, Consumer Expenditure and Transport & Storage have seen smaller emissions reductions (<15%)
* The biggest percentage decrease in emissions has come from Mining & Quarrying with the biggest percentage increase coming from Real Estate
* While Real Estate has seen the biggest percentage increase, Construction has seen the biggest absolute increase
* The largest absolute decrease in emissions has been in Electricity Supply
```{r}
# percentage changes
ghg_section_pct_changes <- ghg_section_totals |>
  rowwise(`Section name`) |>
  summarise(pct_change = ((`2021` - `1990`)/`1990`)*100) |>
  arrange(desc(pct_change))

# absolute changes
ghg_section_absolute_changes <- ghg_section_totals |>
  rowwise(`Section name`) |>
  summarise(absolute_change = `2021` - `1990`) |>
  arrange(desc(absolute_change))
```



### Sectors
Sectors contributing the most to emissions:

* Since 1991, 7 sectors have produced more than 1 million thousand tonnes of CO2e
* These 7 sectors were also the top emitters in 2021
* 5 feature in the top 7 emitters of 1990 with Manufacture of petrochemicals and Mining of coal and lignite rounding out the list in place of Electricity production - gas and Air transport services
```{r}
# total emissions over period
ghg_sector_total_period <- ghg_sector_totals |>
  rowwise(Sector) |>
  summarise(total_emissions = sum(c_across("1990":"2021"))) |>
  arrange(desc(total_emissions))

# top 7 emitters in 2021
top_emitting_sectors_2021 <- ghg_sector_totals |>
  slice_max(order_by = `2021`, n = 7)

# top 7 emitters in 1990
top_emitting_sectors_1990 <- ghg_sector_totals |>
  slice_max(order_by = `1990`, n = 7)

setdiff(top_emitting_sectors_2021$Sector, top_emitting_sectors_1990$Sector)
setdiff(top_emitting_sectors_1990$Sector, top_emitting_sectors_2021$Sector)
```


Industries reducing emissions the quickest and the slowest:

* Of the 131 sectors, 100 have reduced emissions over the 31-year period
* Electricity production has experienced the largest increases and reductions in emissions
* Production using oil has seen the greatest decrease while production from other sources has seen the greatest increases in emissions (by both percentage and absolute number)
```{r}
# percentage changes
ghg_sector_pct_changes <- ghg_sector_totals |>
  rowwise(`Sector`) |>
  summarise(pct_change = ((`2021` - `1990`)/`1990`)*100) |>
  arrange(desc(pct_change))

# absolute changes
ghg_section_absolute_changes <- ghg_sector_totals |>
  rowwise(`Sector`) |>
  summarise(absolute_change = `2021` - `1990`) |>
  arrange(desc(absolute_change))
```



___
## How might emissions change over the next 5 years?

### Forecasting total emissions

```{r}
# create time series object
ts_annual_emissions <- ts(annual_emissions$Emissions, frequency = 1, start = 1990, end = 2021)

# autocorrelation and partial acf
autocor_annual_emissions <- acf(ts_annual_emissions) # significant autocorrelation for x + 7
p_autocor_annual_emissions <- pacf(ts_annual_emissions) # indicates that there is non-significant noise influencing autocorrelation

# ARIMA
model_annual_emissions <- auto.arima(y = ts_annual_emissions)
model_annual_emissions

# check if this is a good model
acf(model_annual_emissions$residuals)
pacf(model_annual_emissions$residuals) # both indicate stationarity

# forecast
forecast_annual_emissions <- forecast(model_annual_emissions, h = 5, level = 30)

# plot forecast
autoplot(forecast_annual_emissions,
         fcol = primary) +
  geom_forecast(forecast_annual_emissions, showgap = F, colour = primary) +
  theme_nao

# forecast table
forecast_annual_emissions
```

### Forecasting emissions at the industry level

```{r}
industries <- unique(ghg_section_totals$`Section name`)

forecast_industry_emissions <- map(industries, industry_forecast, ghg_section_totals)
names(forecast_industry_emissions) <- industries
forecast_industry_emissions_plots <- map(forecast_industry_emissions, autoplot) 

# add a shiny widget to select table and plot (add layers to plot)
```


___
## What are the implications of this for the UK government?